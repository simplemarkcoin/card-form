<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Checkout Payment — U.S.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>
<body class="bg-gray-100">
  <section class="min-h-screen flex items-center justify-center px-4 sm:px-8 py-8">
    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-lg p-6 sm:p-10 border border-gray-200">
      <div class="grid lg:grid-cols-2 gap-12">
        <!-- Left: Illustration & Trust -->
        <div class="flex flex-col justify-center items-center text-center">
          <div class="aspect-[10/5] w-full">
            <img src="https://readymadeui.com/images/payment-img.webp" alt="Payment Illustration" class="w-full h-full object-contain object-center" />
          </div>
          <div class="mt-8">
            <h1 class="text-3xl font-bold text-slate-900 flex items-center justify-center">
              Secure Payment Gateway
              <svg class="ml-2 w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12M3 17h18M3 12h18M3 7h18"></path>
              </svg>
            </h1>
            <p class="mt-2 text-slate-500 text-sm max-w-sm mx-auto">
              Complete your payment securely with tokenization. PCI-compliant processing.
            </p>
          </div>
          <div class="flex items-center justify-center gap-3 mt-6">
            <img src="https://readymadeui.com/images/visa.webp" class="w-10" alt="Visa" />
            <img src="https://readymadeui.com/images/american-express.webp" class="w-10" alt="Amex" />
            <img src="https://readymadeui.com/images/master.webp" class="w-10" alt="MasterCard" />
          </div>
        </div>

        <!-- Right: Form -->
        <form id="checkoutForm" novalidate>
          <h2 class="text-xl font-semibold text-slate-900">Complete Payment</h2>
          <div aria-live="polite" id="error-summary" class="sr-only"></div>

          <!-- Billing Address -->
          <div class="mt-6">
            <h3 class="text-base font-semibold text-slate-800">Billing Address</h3>
            <div class="grid md:grid-cols-2 gap-4 mt-4">
              <div class="md:col-span-2">
                <label for="street" class="block text-sm font-medium text-slate-600 mb-2">Street Address *</label>
                <input type="text" id="street" name="street" required placeholder="1234 Main St" autocomplete="street-address"
                       class="w-full px-4 py-3 rounded-md border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                       aria-required="true" autofocus oninput="validateField(this)" />
                <p class="mt-1 text-xs text-red-500 hidden" id="error-street"></p>
              </div>

              <div>
                <label for="city" class="block text-sm font-medium text-slate-600 mb-2">City *</label>
                <input type="text" id="city" name="city" required placeholder="Enter city" autocomplete="address-level2"
                       class="w-full px-4 py-3 rounded-md border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none capitalize"
                       aria-required="true" oninput="validateField(this)" />
                <p class="mt-1 text-xs text-red-500 hidden" id="error-city"></p>
              </div>

              <div>
                <label for="state" class="block text-sm font-medium text-slate-600 mb-2">State *</label>
                <select id="state" name="state" required autocomplete="address-level1"
                        class="w-full px-4 py-3 rounded-md border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none capitalize"
                        aria-required="true" oninput="validateField(this)">
                  <option value="">Select state</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
                <p class="mt-1 text-xs text-red-500 hidden" id="error-state"></p>
              </div>

              <div>
                <label for="zip" class="block text-sm font-medium text-slate-600 mb-2">ZIP Code *</label>
                <input type="text" id="zip" name="zip" required placeholder="12345" pattern="\d{5}" maxlength="5" autocomplete="postal-code"
                       class="w-full px-4 py-3 rounded-md border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                       aria-required="true" oninput="validateField(this)" />
                <p class="mt-1 text-xs text-red-500 hidden" id="error-zip"></p>
              </div>
            </div>
          </div>

          <!-- Payment Information -->
          <div class="mt-8">
            <h3 class="text-base font-semibold text-slate-800">Payment Information</h3>
            <div class="grid md:grid-cols-2 gap-4 mt-4">
              <div class="md:col-span-2">
                <label for="card_name" class="block text-sm font-medium text-slate-600 mb-2">Cardholder’s Name *</label>
                <input type="text" id="card_name" name="card_name" required placeholder="Name on card" autocomplete="cc-name"
                       class="w-full px-4 py-3 rounded-md border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                       aria-required="true" oninput="validateField(this)" />
                <p class="mt-1 text-xs text-red-500 hidden" id="error-card_name"></p>
              </div>

              <div class="md:col-span-2 relative">
                <label class="block text-sm font-medium text-slate-600 mb-2">Card Number *</label>
                <div id="card-number" class="w-full px-4 py-3 rounded-md border border-gray-300 focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500"></div>
                <img id="card-brand" class="absolute right-3 top-10 w-8 h-6 hidden" alt="Card Brand" />
                <p class="mt-1 text-xs text-red-500 hidden" id="error-card-number"></p>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600 mb-2">Expiry (MM/YY) *</label>
                <div id="card-expiry" class="w-full px-4 py-3 rounded-md border border-gray-300 focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500"></div>
                <p class="mt-1 text-xs text-red-500 hidden" id="error-expiry"></p>
              </div>

              <div class="relative">
                <label class="block text-sm font-medium text-slate-600 mb-2">CVV *</label>
                <div id="card-cvc" class="w-full px-4 py-3 rounded-md border border-gray-300 focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500"></div>
                <span class="absolute right-3 top-2 cursor-help" title="3-digit code on back of card (Amex: 4 on front)">?</span>
                <p class="mt-1 text-xs text-red-500 hidden" id="error-cvv"></p>
              </div>
            </div>

            <div class="mt-8">
              <button type="submit" class="w-full py-3 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition flex items-center justify-center" id="submitBtn">
                <span id="btn-text">Pay Now</span>
                <svg id="btn-spinner" class="hidden animate-spin h-5 w-5 ml-2 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>
              <p class="mt-2 text-xs text-center text-gray-500">Secure payment via Stripe. No data stored.</p>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <script>
    // Stripe Setup (Replace with your publishable key)
    const stripe = Stripe('pk_test_your_publishable_key');
    const elements = stripe.elements();
    const style = { base: { fontSize: '16px', color: '#32325d' } };

    const cardNumber = elements.create('cardNumber', { style });
    cardNumber.mount('#card-number');
    const cardExpiry = elements.create('cardExpiry', { style });
    cardExpiry.mount('#card-expiry');
    const cardCvc = elements.create('cardCvc', { style });
    cardCvc.mount('#card-cvc');

    // Rate Limiting
    const RATE_LIMIT = { max: 5, windowMs: 60 * 1000 };
    function checkRateLimit() {
      const attempts = JSON.parse(localStorage.getItem('submitAttempts') || '[]');
      const now = Date.now();
      const recent = attempts.filter(t => now - t < RATE_LIMIT.windowMs);
      if (recent.length >= RATE_LIMIT.max) {
        alert('Too many attempts. Please wait a minute.');
        return false;
      }
      recent.push(now);
      localStorage.setItem('submitAttempts', JSON.stringify(recent.slice(-RATE_LIMIT.max)));
      return true;
    }

    // Input Sanitization
    function sanitizeInput(value) {
      const div = document.createElement('div');
      div.textContent = value;
      return div.innerHTML.replace(/[<>&]/g, '');
    }

    // Validation Functions
    function showError(input, msg) {
      const id = input.id || input.elementType;
      const errEl = document.getElementById(`error-${id}`);
      errEl.textContent = msg;
      errEl.classList.remove('hidden');
      input.classList?.add('border-red-500');
      document.getElementById('error-summary').textContent = msg; // ARIA live update
    }

    function clearError(input) {
      const id = input.id || input.elementType;
      const errEl = document.getElementById(`error-${id}`);
      errEl.classList.add('hidden');
      input.classList?.remove('border-red-500');
    }

    function validateField(input) {
      clearError(input);
      const value = input.value.trim();
      const name = input.name;

      if (!value) {
        showError(input, 'This field is required.');
        return false;
      }

      if (name === 'street') {
        const sanitized = sanitizeInput(value);
        if (sanitized.length < 5) {
          showError(input, 'Street address must be at least 5 characters.');
          return false;
        }
        if (!/^[a-zA-Z0-9\s,.-]+$/.test(sanitized)) {
          showError(input, 'Street address contains invalid characters.');
          return false;
        }
        input.value = sanitized;
      } else if (name === 'city') {
        const sanitized = sanitizeInput(value);
        if (sanitized.length < 2) {
          showError(input, 'City must be at least 2 characters.');
          return false;
        }
        if (!/^[a-zA-Z\s]+$/.test(sanitized)) {
          showError(input, 'City can only contain letters and spaces.');
          return false;
        }
        input.value = sanitized;
      } else if (name === 'state') {
        if (value === '') {
          showError(input, 'Please select a state.');
          return false;
        }
      } else if (name === 'zip') {
        if (!/^\d{5}$/.test(value)) {
          showError(input, 'ZIP must be 5 digits.');
          return false;
        }
      } else if (name === 'card_name') {
        const sanitized = sanitizeInput(value);
        if (sanitized.length < 2) {
          showError(input, 'Name must be at least 2 characters.');
          return false;
        }
        if (!/^[a-zA-Z\s]+$/.test(sanitized)) {
          showError(input, 'Name can only contain letters and spaces.');
          return false;
        }
        input.value = sanitized;
      }

      return true;
    }

    // Stripe Validation
    cardNumber.on('change', (event) => {
      showStripeError('card-number', event);
      if (event.brand && event.brand !== 'unknown') {
        document.getElementById('card-brand').src = `https://readymadeui.com/images/${event.brand.toLowerCase()}.webp`;
        document.getElementById('card-brand').classList.remove('hidden');
      } else {
        document.getElementById('card-brand').classList.add('hidden');
      }
    });

    cardExpiry.on('change', (event) => {
      showStripeError('expiry', event);
      if (!event.error && event.complete) {
        const [month, year] = document.querySelector('#card-expiry input')?.value.split('/') || [];
        const now = new Date();
        const currentYear = now.getFullYear() % 100;
        const currentMonth = now.getMonth() + 1;
        if (parseInt(year) < currentYear || (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
          showError({ id: 'expiry' }, 'Card expiry must be in the future.');
        }
      }
    });

    cardCvc.on('change', (event) => showStripeError('cvv', event));

    function showStripeError(id, event) {
      const errEl = document.getElementById(`error-${id}`);
      if (event.error) {
        errEl.textContent = event.error.message;
        errEl.classList.remove('hidden');
        document.getElementById('error-summary').textContent = event.error.message;
      } else {
        errEl.classList.add('hidden');
      }
    }

    // Form Submission
    document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!checkRateLimit()) return;

      const form = e.target;
      let valid = true;

      // Validate non-Stripe fields
      form.querySelectorAll('input:not([id^="card-"]), select').forEach(input => {
        if (!validateField(input)) valid = false;
      });

      if (!valid) {
        form.querySelector('.border-red-500')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      const btn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btn-text');
      const spinner = document.getElementById('btn-spinner');
      btn.disabled = true;
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');

      // Create Stripe Token
      const { token, error } = await stripe.createToken(cardNumber, {
        name: sanitizeInput(document.getElementById('card_name').value),
        address_line1: sanitizeInput(document.getElementById('street').value),
        address_city: sanitizeInput(document.getElementById('city').value),
        address_state: document.getElementById('state').value,
        address_zip: document.getElementById('zip').value,
      });

      if (error) {
        showStripeError('card-number', { error });
        btn.disabled = false;
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        return;
      }

      // Example backend payload (server should validate all fields again)
      const payload = {
        token: token.id,
        billing: {
          street: sanitizeInput(document.getElementById('street').value),
          city: sanitizeInput(document.getElementById('city').value),
          state: document.getElementById('state').value,
          zip: document.getElementById('zip').value,
        }
        // Backend should: Validate formats, check ZIP against city/state, verify token with Stripe
      };

      try {
        const res = await fetch('/api/pay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          window.location.href = '/success';
        } else {
          const json = await res.json();
          alert(json.message || 'Payment failed.');
        }
      } catch (err) {
        alert('Network error. Please check your connection.');
      } finally {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
